!function(s,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((s=s||self).CTalk={})}(this,function(s){"use strict";function d(){this.events=[]}function h(s,t,e,i,n,o,a,r){this.number=s,this.action=t,this.originType=e,this.originUUID=i,void 0!==n&&(this.destinationType=n),void 0!==o&&(this.destinationUUID=o),void 0!==a&&(this.data=a),void 0!==r&&(this.authentication=r),this.hops=[]}function p(s){this.manager=s,this.window=null,this.url="",this.uuid=null,this.type=null,this.counter=0,this.gateway=null,this.status=p.WAITING,this.queue=[],this.allowdomain="*",this.onMessage=null,this.onBroadcastMessage=null,this.onClosed=null,this.onReady=null}function t(s){var u=this;this.type=s,this.uuid=t.generateUUID(),this.sessions={},this.waitingSessions=[],this.onBroadcastMessage=null,this.manager=new d,this.manager.add(window,"message",function(s){var t=s.data;if(void 0===t.destinationUUID||t.destinationUUID===u.uuid){if(t.action===h.CLOSED)void 0!==(r=u.sessions[t.originUUID])&&(null!=r.onClose&&r.onClose(),delete u.sessions[t.originUUID]);else if(t.action===h.LOOKUP){var e=!1;for(var i in u.sessions){if((r=u.sessions[i]).type===t.destinationType){var n=new h(0,h.LOOKUP_FOUND,u.type,u.uuid,void 0,void 0,{uuid:r.uuid,type:r.type});e=!0;break}}!1===e&&(n=new h(0,h.LOOKUP_NOT_FOUND,u.type,u.uuid)),void 0!==(r=u.sessions[t.originUUID])&&r.send(n)}else if(t.action===h.CONNECT){var o=t.hops.pop(),a=u.sessions[o];if(void 0!==a)(r=new p(u)).uuid=t.originUUID,r.type=t.originType,r.gateway=a,r.waitReady(),r.acknowledge()}else if(t.action===h.BROADCAST)for(var i in null!==u.onBroadcastMessage&&u.onBroadcastMessage(t.data,t.authentication),u.sessions){(r=u.sessions[i]).uuid!==t.originUUID&&(r.send(t),null!==r.onBroadcastMessage&&r.onBroadcastMessage(t.data,t.authentication))}else if(t.action===h.MESSAGE){var r;void 0!==(r=u.sessions[t.originUUID])&&null!==r.onMessage&&r.onMessage(t.data,t.authentication)}}else void 0!==(r=u.sessions[t.destinationUUID])&&(t.hops.push(u.uuid),r.send(t))}),this.manager.add(window,"beforeunload",function(s){for(var t in u.sessions)u.sessions[t].close()}),this.manager.create(),this.checkOpener()}d.prototype.add=function(s,t,e){this.events.push([s,t,e,!1])},d.prototype.clear=function(){this.destroy(),this.events=[]},d.prototype.create=function(){for(var s=0;s<this.events.length;s++){var t=this.events[s];t[0].addEventListener(t[1],t[2]),t[3]=!0}},d.prototype.destroy=function(){for(var s=0;s<this.events.length;s++){var t=this.events[s];t[0].removeEventListener(t[1],t[2]),t[3]=!1}},h.READY=0,h.CLOSED=1,h.LOOKUP=2,h.MESSAGE=3,h.BROADCAST=4,h.LOOKUP_FOUND=5,h.LOOKUP_NOT_FOUND=6,h.CONNECT=7,p.WAITING=101,p.READY=102,p.CLOSED=103,p.prototype.setStatus=function(s){if(!(s<=this.status)&&(this.status=s,this.status===p.READY)){for(var t=0;t<this.queue;t++)this.send(this.queue[t]);this.queue=[]}},p.prototype.send=function(s){if(null!==this.window)this.window.postMessage(s,this.allowdomain);else{if(null===this.gateway)return;this.gateway.send(s)}},p.prototype.sendMessage=function(s,t){var e=new h(this.counter++,h.MESSAGE,this.manager.type,this.manager.uuid,this.type,this.uuid,s,t);this.status===p.WAITING?this.queue.push(e):this.send(e)},p.prototype.close=function(s){var t=new h(this.counter++,h.CLOSED,this.manager.type,this.manager.uuid,this.type,this.uuid);this.sendMessage(t),!0===s&&null!==this.window&&this.window.close()},p.prototype.acknowledge=function(){null!==this.uuid?this.send(new h(this.counter++,h.READY,this.manager.type,this.manager.uuid,this.type,this.uuid)):this.send(new h(this.counter++,h.READY,this.manager.type,this.manager.uuid))},p.prototype.connect=function(){this.send(new h(this.counter++,h.CONNECT,this.manager.type,this.manager.uuid,this.type,this.uuid))},p.prototype.waitReady=function(){var e=this,i=new d;i.add(window,"message",function(s){if(s.source===e.window||null===e.window){var t=s.data;t.action===h.READY&&(e.type=t.originType,e.uuid=t.originUUID,(e.manager.sessions[e.uuid]=e).setStatus(p.READY),e.acknowledge(),null!==e.onReady&&e.onReady(s),i.destroy())}}),i.create()},t.prototype.logSessions=function(){for(var s in this.sessions)this.sessions[s]},t.prototype.broadcast=function(s,t){var e=new h(0,h.BROADCAST,this.manager.type,this.manager.uuid,void 0,void 0,s,t);for(var i in this.sessions)this.sessions[i].send(e)},t.prototype.checkOpener=function(){if(this.wasOpened()){var s=new p(this);return s.window=window.opener,s.acknowledge(),s.waitReady(),s}return null},t.prototype.openSession=function(i,s){for(var t in this.sessions){if((n=this.sessions[t]).type===s)return n}var n;return void 0!==((n=new p(this)).type=s)&&this.lookup(s,function(s,t,e){null===s?null!==i&&(n.url=i,n.window=window.open(i),n.waitReady()):(n.gateway=s,n.uuid=t,n.type=e,n.waitReady(),n.connect())}),n},t.prototype.lookup=function(s,i){var t=new h(0,h.LOOKUP,this.type,this.uuid,s,void 0),n=0,o=0,a=!1;for(var e in this.sessions)this.sessions[e].send(t),n++;if(0<n){var r=this,u=new d;u.add(window,"message",function(s){var t=s.data;if(t.action===h.LOOKUP_FOUND){if(!1===a){var e=r.sessions[t.originUUID];void 0!==e&&(a=!0,i(e,t.data.uuid,t.data.type))}o++}else t.action===h.LOOKUP_NOT_FOUND&&o++;n===o&&(u.destroy(),!1===a&&i(null))}),u.create()}else i(null)},t.prototype.wasOpened=function(){return null!==window.opener},t.prototype.dispose=function(){for(var s in this.sessions)this.sessions[s].close();this.manager.destroy()},t.generateUUID=function(){for(var n=[],s=0;s<256;s++)n[s]=(s<16?"0":"")+s.toString(16);return function(){var s=4294967295*Math.random()|0,t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(n[255&s]+n[s>>8&255]+n[s>>16&255]+n[s>>24&255]+"-"+n[255&t]+n[t>>8&255]+"-"+n[t>>16&15|64]+n[t>>24&255]+"-"+n[63&e|128]+n[e>>8&255]+"-"+n[e>>16&255]+n[e>>24&255]+n[255&i]+n[i>>8&255]+n[i>>16&255]+n[i>>24&255]).toUpperCase()}}(),s.EventManager=d,s.WindowManager=t,s.WindowSession=p,s.WindowMessage=h,Object.defineProperty(s,"__esModule",{value:!0})});