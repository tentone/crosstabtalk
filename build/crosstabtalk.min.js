!function(s,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((s=s||self).CTalk={})}(this,function(s){"use strict";function d(){this.events=[]}function h(s,e,t,i,n,o,a,r){this.number=s,this.action=e,this.originType=t,this.originUUID=i,void 0!==n&&(this.destinationType=n),void 0!==o&&(this.destinationUUID=o),void 0!==a&&(this.data=a),void 0!==r&&(this.authentication=r),this.hops=[]}function p(s){this.manager=s,this.window=null,this.url="",this.uuid=null,this.type=null,this.counter=0,this.gateway=null,this.status=p.WAITING,this.received=[],this.queue=[],this.allowdomain="*",this.onMessage=null,this.onBroadcastMessage=null,this.onClosed=null,this.onReady=null}function e(s){var u=this;this.type=s,this.uuid=e.generateUUID(),this.sessions={},this.waitingSessions=[],this.onBroadcastMessage=null,this.onMessage=null,this.manager=new d,this.manager.add(window,"message",function(s){var e=s.data;if(void 0===e.destinationUUID||e.destinationUUID===u.uuid){if(e.action===h.CLOSED)void 0!==(r=u.sessions[e.originUUID])&&(null!=r.onClose&&r.onClose(),delete u.sessions[e.originUUID]);else if(e.action===h.LOOKUP){var t=!1;for(var i in u.sessions){if((r=u.sessions[i]).type===e.destinationType){var n=new h(0,h.LOOKUP_FOUND,u.type,u.uuid,void 0,void 0,{uuid:r.uuid,type:r.type});t=!0;break}}!1===t&&(n=new h(0,h.LOOKUP_NOT_FOUND,u.type,u.uuid)),void 0!==(r=u.sessions[e.originUUID])&&r.send(n)}else if(e.action===h.CONNECT){var o=e.hops.pop(),a=u.sessions[o];if(void 0!==a)(r=new p(u)).uuid=e.originUUID,r.type=e.originType,r.gateway=a,r.waitReady(),r.acknowledge()}else if(e.action===h.BROADCAST)for(var i in null!==u.onBroadcastMessage&&u.onBroadcastMessage(e.data,e.authentication),e.hops.push(u.uuid),u.sessions){(r=u.sessions[i]).uuid!==e.originUUID&&-1===e.hops.indexOf(r.uuid)&&(r.send(e),null!==r.onBroadcastMessage&&r.onBroadcastMessage(e.data,e.authentication))}else if(e.action===h.MESSAGE){var r;null!==u.onMessage&&u.onMessage(e.originType,e.data,e.authentication),void 0!==(r=u.sessions[e.originUUID])&&(r.received.push(e),null!==r.onMessage&&r.onMessage(e.data,e.authentication))}}else void 0!==(r=u.sessions[e.destinationUUID])&&(e.hops.push(u.uuid),r.send(e))}),this.manager.add(window,"beforeunload",function(s){for(var e in u.sessions)u.sessions[e].close()}),this.manager.create(),this.checkOpener()}d.prototype.add=function(s,e,t){this.events.push([s,e,t,!1])},d.prototype.clear=function(){this.destroy(),this.events=[]},d.prototype.create=function(){for(var s=0;s<this.events.length;s++){var e=this.events[s];e[0].addEventListener(e[1],e[2]),e[3]=!0}},d.prototype.destroy=function(){for(var s=0;s<this.events.length;s++){var e=this.events[s];e[0].removeEventListener(e[1],e[2]),e[3]=!1}},h.READY=0,h.CLOSED=1,h.LOOKUP=2,h.MESSAGE=3,h.BROADCAST=4,h.LOOKUP_FOUND=5,h.LOOKUP_NOT_FOUND=6,h.CONNECT=7,p.WAITING=101,p.READY=102,p.CLOSED=103,p.prototype.setStatus=function(s){if(!(s<=this.status)&&(this.status=s,this.status===p.READY)){for(var e=0;e<this.queue;e++)this.send(this.queue[e]);this.queue=[]}},p.prototype.send=function(s){if(null!==this.window)this.window.postMessage(s,this.allowdomain);else{if(null===this.gateway)return;this.gateway.send(s)}},p.prototype.sendMessage=function(s,e){var t=new h(this.counter++,h.MESSAGE,this.manager.type,this.manager.uuid,this.type,this.uuid,s,e);this.status===p.WAITING?this.queue.push(t):this.send(t)},p.prototype.close=function(s){var e=new h(this.counter++,h.CLOSED,this.manager.type,this.manager.uuid,this.type,this.uuid);this.sendMessage(e),!0===s&&null!==this.window&&this.window.close()},p.prototype.acknowledge=function(){null!==this.uuid?this.send(new h(this.counter++,h.READY,this.manager.type,this.manager.uuid,this.type,this.uuid)):this.send(new h(this.counter++,h.READY,this.manager.type,this.manager.uuid))},p.prototype.connect=function(){this.send(new h(this.counter++,h.CONNECT,this.manager.type,this.manager.uuid,this.type,this.uuid))},p.prototype.waitReady=function(){var t=this,i=new d;i.add(window,"message",function(s){if(s.source===t.window||null===t.window){var e=s.data;e.action===h.READY&&(t.type=e.originType,t.uuid=e.originUUID,(t.manager.sessions[t.uuid]=t).setStatus(p.READY),t.acknowledge(),null!==t.onReady&&t.onReady(s),i.destroy())}}),i.create()},e.prototype.logSessions=function(){for(var s in this.sessions)this.sessions[s]},e.prototype.broadcast=function(s,e){var t=new h(0,h.BROADCAST,this.manager.type,this.manager.uuid,void 0,void 0,s,e);for(var i in this.sessions)this.sessions[i].send(t)},e.prototype.checkOpener=function(){if(this.wasOpened()){var s=new p(this);return s.window=window.opener,s.acknowledge(),s.waitReady(),s}return null},e.prototype.openSession=function(i,s){for(var e in this.sessions){if((n=this.sessions[e]).type===s)return n}var n;return void 0!==((n=new p(this)).type=s)&&this.lookup(s,function(s,e,t){null===s?null!==i&&(n.url=i,n.window=window.open(i),n.waitReady()):(n.gateway=s,n.uuid=e,n.type=t,n.waitReady(),n.connect())}),n},e.prototype.getSession=function(s){for(var e in this.sessions){var t=this.sessions[e];if(t.type===s)return t}return null},e.prototype.sessionExists=function(s){for(var e in this.sessions)if(this.sessions[e].type===s)return!0;return!1},e.prototype.lookup=function(s,i){var e=new h(0,h.LOOKUP,this.type,this.uuid,s,void 0),n=0,o=0,a=!1;for(var t in this.sessions)this.sessions[t].send(e),n++;if(0<n){var r=this,u=new d;u.add(window,"message",function(s){var e=s.data;if(e.action===h.LOOKUP_FOUND){if(!1===a){var t=r.sessions[e.originUUID];void 0!==t&&(a=!0,i(t,e.data.uuid,e.data.type))}o++}else e.action===h.LOOKUP_NOT_FOUND&&o++;n===o&&(u.destroy(),!1===a&&i(null))}),u.create()}else i(null)},e.prototype.wasOpened=function(){return null!==window.opener},e.prototype.dispose=function(){for(var s in this.sessions)this.sessions[s].close();this.manager.destroy()},e.generateUUID=function(){for(var n=[],s=0;s<256;s++)n[s]=(s<16?"0":"")+s.toString(16);return function(){var s=4294967295*Math.random()|0,e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(n[255&s]+n[s>>8&255]+n[s>>16&255]+n[s>>24&255]+"-"+n[255&e]+n[e>>8&255]+"-"+n[e>>16&15|64]+n[e>>24&255]+"-"+n[63&t|128]+n[t>>8&255]+"-"+n[t>>16&255]+n[t>>24&255]+n[255&i]+n[i>>8&255]+n[i>>16&255]+n[i>>24&255]).toUpperCase()}}(),s.EventManager=d,s.WindowManager=e,s.WindowSession=p,s.WindowMessage=h,Object.defineProperty(s,"__esModule",{value:!0})});